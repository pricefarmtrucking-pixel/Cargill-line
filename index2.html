<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FarmPro • Multi-Lane Map & Rate Calculator</title>
  <style>
    :root{
      --bg:#0b1016; --panel:#111924; --muted:#9fb0c2; --text:#e8f0fb; --accent:#48c78e; --accent2:#1a73e8; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    /* Left column made wider so the map is a smaller portion of the page */
    .app{display:grid;grid-template-columns:480px 1fr;min-height:100vh}
    .left{background:var(--panel);padding:16px;overflow:auto;border-right:1px solid #1b2532}
    .right{position:relative}
    h1{margin:0 0 10px;font-size:18px;letter-spacing:.2px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 12px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #203044;background:#0e1520;color:var(--text)}
    input[type="checkbox"]{transform:scale(1.1)}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #2a3a4f;background:#162233;color:#fff;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:var(--accent2);border-color:#1e5fbc}
    .btn.success{background:var(--accent);border-color:#2da373}
    .btn.ghost{background:#101827;border-color:#243244}
    .btn.warning{background:#4b5563;border-color:#374151}
    .section{padding:10px 0;border-top:1px solid #1b2532;margin-top:10px}
    .lane{background:#0e1520;border:1px solid #233247;border-radius:12px;padding:10px;margin:8px 0}
    .lane.dragging{opacity:.6;outline:2px dashed #2a3a4f}
    .lane > .row{margin:8px 0}
    .lane h3{margin:0;font-size:14px;color:#cfe2f7}
    .lane small{color:var(--muted)}
    .iconbtn{background:transparent;border:1px solid #34465f;border-radius:8px;color:#a3b6ce;padding:6px 8px;cursor:pointer}
    .iconbtn:hover{background:#182334}
    #map{position:absolute;inset:0}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #223045;text-align:right}
    th{color:#c3d4e9;font-weight:600}
    td:first-child, th:first-child{text-align:left}
    tfoot td{font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid #2a3a4f;border-radius:999px}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .tag{font-size:11px;background:#0b1320;border:1px solid #22334a;border-radius:999px;padding:2px 6px;color:#cfe2f7}
    .legend{display:flex;gap:8px;align-items:center}
    .swatch{width:18px;height:3px;border-radius:2px}

    /* Saved Lanes shelf (added) */
    .shelf{background:#0e1520;border:1px solid #233247;border-radius:12px;padding:10px;margin:8px 0}
    .shelf h3{margin:0 0 8px;font-size:14px;color:#cfe2f7}
    .saved-list{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
    .saved-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid #233247;border-radius:10px;background:#0b1320}
    .saved-item .meta{flex:1;min-width:0}
    .saved-item .t{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ghostbtn{background:#101827;border-color:#243244;color:#cfe2f7}
  </style>
</head>
<body>
  <div class="app">
    <aside class="left">
      <h1>FarmPro • Multi-Lane Map & RPM Calculator</h1>
      <div class="row legend">
        <span class="tag">Legend</span>
        <span class="swatch" style="background:#1a73e8"></span><span class="muted">Loaded</span>
        <span class="swatch" style="background:linear-gradient(90deg,#808080 33%,transparent 33%,transparent 66%,#808080 66%)"></span><span class="muted">Deadhead</span>
      </div>

      <div class="section">
        <div class="row">
          <div style="flex:1">
            <label>Base / Yard (optional)</label>
            <input id="base" type="text" placeholder="e.g., Fairbank, IA" />
          </div>
        </div>
        <div class="row">
          <label class="pill"><input id="includeStartDH" type="checkbox" checked> Include deadhead from Base → first Origin</label>
          <label class="pill"><input id="returnToBase" type="checkbox"> Add final deadhead from last Destination → Base</label>
        </div>
        <div class="controls">
          <button type="button" class="btn success" id="addLane">+ Add lane</button>
          <button type="button" class="btn primary" id="calc">Calculate & Map</button>
          <button type="button" class="btn warning" id="optimize">Optimize Order (RPM)</button>
          <button type="button" class="btn ghost" id="sample">Load sample</button>
          <button type="button" class="btn" id="clearAll">Clear</button>
        </div>
      </div>

      <div id="lanes"></div>

      <!-- NEW: Saved Lanes shelf -->
      <div class="section shelf">
        <h3>Saved Lanes</h3>
        <div class="row" style="gap:6px;margin-bottom:6px">
          <button type="button" class="btn" id="saveSelected">Save selected lane</button>
          <button type="button" class="btn ghostbtn" id="exportLib">Export</button>
          <button type="button" class="btn ghostbtn" id="importLib">Import</button>
        </div>
        <div class="saved-list" id="savedList"></div>
        <div class="note">Tap a lane’s card ➕ to insert into the plan. On desktop you can also drag it into position.</div>
      </div>

      <div class="section">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div><span class="tag">Results</span></div>
          <div class="row">
            <button type="button" class="btn" id="exportCsv">Export CSV</button>
            <button type="button" class="btn" id="emailBtn">Open Proposal</button>
          </div>
        </div>
        <table id="resultsTable" hidden>
          <thead>
            <tr>
              <th>Lane</th>
              <th>Origin → Destination</th>
              <th>Loaded mi</th>
              <th>Deadhead mi</th>
              <th>Rate $/ton</th>
              <th>Tons</th>
              <th>Gross $</th>
              <th>Lane RPM</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="2">Totals</td>
              <td id="tLoaded"></td>
              <td id="tDeadhead"></td>
              <td></td><td></td>
              <td id="tGross"></td>
              <td id="tRPM"></td>
            </tr>
          </tfoot>
        </table>
        <div class="note">Overall RPM = Total Gross ÷ (Loaded + Deadhead). Also shown on the proposal page with a loaded-only RPM.</div>
      </div>
    </aside>

    <main class="right">
      <div id="map"></div>
    </main>
  </div>

  <template id="laneTmpl">
    <div class="lane" draggable="true">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>Lane <span class="laneIndex"></span> <small class="muted">(Origin → Destination)</small></h3>
        <div class="row">
          <button type="button" class="iconbtn moveUp" title="Move up">▲</button>
          <button type="button" class="iconbtn moveDown" title="Move down">▼</button>
          <button type="button" class="iconbtn del" title="Remove lane">Remove</button>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Origin</label>
          <input type="text" class="origin" placeholder="City, ST or full address" />
        </div>
        <div style="flex:1">
          <label>Destination</label>
          <input type="text" class="destination" placeholder="City, ST or full address" />
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Rate ($/ton)</label>
          <input type="number" class="rate" placeholder="e.g., 19" step="0.01" />
        </div>
        <div style="flex:1">
          <label>Tons</label>
          <input type="number" class="tons" placeholder="e.g., 26" step="0.1" />
        </div>
      </div>
    </div>
  </template>

  <script>
    let map, bounds, dirService, dmService=null;
    const polylines = [];
    let lastCompute = null;
    let library = []; // saved lanes

    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const $  = (sel, ctx=document) => ctx.querySelector(sel);
    const metersToMiles = m => m / 1609.344;
    const fmtMi    = n => (Math.round(n * 10) / 10).toLocaleString(undefined,{minimumFractionDigits:1, maximumFractionDigits:1});
    const fmtMoney = n => n.toLocaleString(undefined,{style:'currency',currency:'USD'});

    document.addEventListener('DOMContentLoaded', setupUI);

    function setupUI(){
      // existing controls
      $('#addLane').addEventListener('click', ()=>addLane());
      $('#calc').addEventListener('click', calculateAndMap);
      $('#sample').addEventListener('click', loadSample);
      $('#clearAll').addEventListener('click', clearAll);
      $('#exportCsv').addEventListener('click', exportCSV);
      $('#emailBtn').addEventListener('click', openProposal);

      // NEW: optimize + saved lanes actions
      $('#optimize').addEventListener('click', optimizeOrder);
      $('#saveSelected').addEventListener('click', saveSelectedLane);
      $('#exportLib').addEventListener('click', exportLibrary);
      $('#importLib').addEventListener('click', importLibrary);

      // drag reorder (existing)
      const wrap = $('#lanes');
      wrap.addEventListener('dragover', e=>{
        e.preventDefault();
        const dragging = document.querySelector('.lane.dragging');
        if(!dragging) return;
        const siblings = [...wrap.querySelectorAll('.lane:not(.dragging)')];
        const next = siblings.find(sib => e.clientY <= sib.getBoundingClientRect().top + sib.offsetHeight/2);
        wrap.insertBefore(dragging, next || null);
      });

      if(!loadFromURL()) loadFromStorage();
      loadLibrary(); renderLibrary();
      if(!$('#lanes').children.length) addLane();
    }

    function safeAutocomplete(input){
      try{
        if (google?.maps?.places?.Autocomplete) {
          new google.maps.places.Autocomplete(input, { fields:['geometry','name'], types:['geocode'] });
        }
      } catch(_){}
    }

    function initMap(){
      try{
        map = new google.maps.Map(document.getElementById('map'), {
          center:{lat:41.878, lng:-93.097}, zoom:6, mapId:'fde12c0d9b0a8c86'
        });
        bounds = new google.maps.LatLngBounds();
        dirService = new google.maps.DirectionsService();
        dmService  = new google.maps.DistanceMatrixService();
        safeAutocomplete($('#base'));
      }catch(e){ console.warn('Maps init failed:', e); }
    }

    function addLane(data={}){
      const wrap = $('#lanes');
      const tmpl = $('#laneTmpl');
      const node = tmpl.content.firstElementChild.cloneNode(true);
      wrap.appendChild(node);
      refreshLaneIndices();

      const o = node.querySelector('.origin');
      const d = node.querySelector('.destination');
      safeAutocomplete(o); safeAutocomplete(d);

      if(data.origin) o.value = data.origin;
      if(data.destination) d.value = data.destination;
      if(data.rate!=null) node.querySelector('.rate').value = data.rate;
      if(data.tons!=null) node.querySelector('.tons').value = data.tons;

      node.querySelector('.del').addEventListener('click', ()=>{ node.remove(); refreshLaneIndices(); persist(); });
      node.querySelector('.moveUp').addEventListener('click', ()=> moveLane(node,-1));
      node.querySelector('.moveDown').addEventListener('click', ()=> moveLane(node,+1));

      node.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain','drag'); node.classList.add('dragging'); });
      node.addEventListener('dragend',   ()=>{ node.classList.remove('dragging'); persist(); refreshLaneIndices(); });

      // mark selected (for "Save selected lane")
      node.addEventListener('focusin', ()=>{ $$('#lanes .lane').forEach(x=>x.classList.remove('selected')); node.classList.add('selected'); });
      node.addEventListener('click', ()=>{ $$('#lanes .lane').forEach(x=>x.classList.remove('selected')); node.classList.add('selected'); });

      $$('.origin,.destination,.rate,.tons', node).forEach(inp=>{
        inp.addEventListener('change', persist);
        inp.addEventListener('blur', persist);
      });
      persist();
    }

    function moveLane(node, dir){
      const wrap = $('#lanes');
      const lanes = $$('#lanes .lane');
      const idx = lanes.indexOf(node);
      const newIdx = idx + dir;
      if(newIdx < 0 || newIdx >= lanes.length) return;
      if(dir < 0) wrap.insertBefore(node, lanes[newIdx]);
      else wrap.insertBefore(node, lanes[newIdx].nextSibling);
      refreshLaneIndices(); persist();
    }
    function refreshLaneIndices(){ $$('#lanes .lane').forEach((lane, i)=>{ lane.querySelector('.laneIndex').textContent = i+1; }); }

    function clearMap(){
      polylines.forEach(p=>p.setMap && p.setMap(null));
      polylines.length = 0;
      bounds = new google.maps.LatLngBounds();
    }

    async function routeMiles(origin, destination){
      return new Promise((resolve, reject)=>{
        if(!dirService){ reject(new Error('Map not initialized')); return; }
        dirService.route({ origin, destination, travelMode:'DRIVING', region:'US' },
          (res, status)=>{
            if(status === 'OK'){
              const leg = res.routes[0].legs[0];
              const path = res.routes[0].overview_path;
              resolve({ miles: metersToMiles(leg.distance.value), path });
            } else {
              reject(new Error(status+': '+origin+' → '+destination));
            }
          }
        );
      });
    }

    function drawPath(path, {color='#1a73e8', weight=4, dash=false}={}){
      if(!map) return;
      const polyline = new google.maps.Polyline({
        map, path, strokeColor: color, strokeOpacity: 1, strokeWeight: weight,
        icons: dash ? [{icon:{path:'M 0,-1 0,1', strokeOpacity:1, scale:2}, offset:'0', repeat:'22px'}] : undefined
      });
      polylines.push(polyline);
      path.forEach(ll=>bounds.extend(ll));
      map.fitBounds(bounds, {top:24,right:24,bottom:24,left:24});
    }

    // ------- Calculate and render (unchanged behavior) -------
    async function calculateAndMap(){
      const lanes = readLanes();
      if(lanes.length===0){ alert('Add at least one lane'); return; }
      if(!dirService){ alert('Map not ready yet.'); return; }

      clearMap();

      const base = $('#base').value.trim();
      const includeStartDH = $('#includeStartDH').checked && base;
      const returnToBase   = $('#returnToBase').checked && base;

      let totals = { loaded:0, deadhead:0, gross:0 };
      const perLane = [];
      let prevDest = null;

      if(includeStartDH){
        try{
          const {miles, path} = await routeMiles(base, lanes[0].origin);
          totals.deadhead += miles;
          drawPath(path, {color:'#808080', weight:4, dash:true});
          prevDest = lanes[0].origin;
        }catch(e){ console.warn(e); prevDest = lanes[0].origin; }
      }

      for(let i=0;i<lanes.length;i++){
        const L = lanes[i];
        if(i>0 || (!includeStartDH && i===0 && prevDest)){
          const from = perLane.length ? perLane[perLane.length-1].destination : prevDest;
          if(from){
            try{
              const {miles, path} = await routeMiles(from, L.origin);
              totals.deadhead += miles; drawPath(path, {color:'#808080', weight:4, dash:true});
            }catch(e){ console.warn(e); }
          }
        }
        try{
          const {miles, path} = await routeMiles(L.origin, L.destination);
          totals.loaded += miles; drawPath(path, {color:'#1a73e8', weight:5});
          const gross = (Number(L.rate)||0) * (Number(L.tons)||0);
          totals.gross += gross;
          perLane.push({ index:i+1, origin:L.origin, destination:L.destination, loaded:miles, deadhead:0, rate:Number(L.rate)||0, tons:Number(L.tons)||0, gross });
        }catch(e){
          console.warn(e);
          const gross = (Number(L.rate)||0) * (Number(L.tons)||0);
          totals.gross += gross;
          perLane.push({ index:i+1, origin:L.origin, destination:L.destination, loaded:0, deadhead:0, rate:Number(L.rate)||0, tons:Number(L.tons)||0, gross });
        }
      }

      // per-lane deadhead totals
      perLane.forEach(pl=>pl.deadhead=0);
      const dhPairs=[];
      if(includeStartDH && perLane[0]) dhPairs.push([base, perLane[0].origin, 0]);
      for(let i=1;i<perLane.length;i++) dhPairs.push([perLane[i-1].destination, perLane[i].origin, i]);
      const dhPromises = dhPairs.map(([a,b,idx])=> routeMiles(a,b).then(r=>({idx,miles:r.miles})).catch(()=>({idx,miles:0})));
      const dhRes = await Promise.all(dhPromises);
      dhRes.forEach(({idx,miles})=>{ if(idx>=0 && perLane[idx]) perLane[idx].deadhead += miles; });

      // final deadhead back to base
      let finalDhMiles = 0;
      if(returnToBase){
        try{
          const last = perLane[perLane.length-1];
          const {miles, path} = await routeMiles(last.destination, base);
          finalDhMiles = miles; totals.deadhead += miles; drawPath(path, {color:'#808080', weight:4, dash:true});
        }catch(e){ console.warn(e); }
      }

      lastCompute = { perLane, totals, finalDhMiles, base, includeStartDH, returnToBase, url: location.href };
      renderResults(perLane, totals, { finalDhMiles });
      persist();
      updateShareURL();
    }

    function readLanes(){
      const list = [];
      $$('#lanes .lane').forEach(el=>{
        const origin = el.querySelector('.origin').value.trim();
        const destination = el.querySelector('.destination').value.trim();
        const rate = parseFloat(el.querySelector('.rate').value);
        const tons = parseFloat(el.querySelector('.tons').value);
        if(origin && destination){ list.push({origin, destination, rate, tons}); }
      });
      return list;
    }

    function renderResults(perLane, totals, opts={}){
      const { finalDhMiles=0 } = opts;
      const table = $('#resultsTable');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';

      let loaded = 0, deadhead = 0, gross = 0;
      perLane.forEach(L=>{ loaded += L.loaded; deadhead += L.deadhead; gross += L.gross; });
      deadhead += finalDhMiles;

      perLane.forEach(L=>{
        const tr = document.createElement('tr');
        const laneRPM = L.gross / (L.loaded + L.deadhead || 1);
        tr.innerHTML = `
          <td>${L.index}</td>
          <td style="text-align:left">${escapeHtml(L.origin)} → ${escapeHtml(L.destination)}</td>
          <td>${fmtMi(L.loaded)}</td>
          <td>${fmtMi(L.deadhead)}</td>
          <td>${L.rate?Number(L.rate).toFixed(2):''}</td>
          <td>${L.tons?Number(L.tons).toFixed(1):''}</td>
          <td>${fmtMoney(L.gross||0)}</td>
          <td>${laneRPM?laneRPM.toFixed(2):''}</td>
        `;
        tbody.appendChild(tr);
      });

      $('#tLoaded').textContent = fmtMi(loaded);
      $('#tDeadhead').textContent = fmtMi(deadhead);
      $('#tGross').textContent = fmtMoney(gross);
      const totalMiles = loaded + deadhead;
      const rpm = gross / (totalMiles || 1);
      $('#tRPM').textContent = rpm.toFixed(2);
      table.hidden = false;

      const note = document.querySelector('.note');
      if(finalDhMiles>0){
        note.textContent = `Overall RPM = Total Gross ÷ (Loaded + Deadhead). Includes ${fmtMi(finalDhMiles)} mi return-to-base deadhead.`;
      } else {
        note.textContent = 'Overall RPM = Total Gross ÷ (Loaded + Deadhead).';
      }
    }

    function exportCSV(){
      const perLane = collectPerLaneFromTable();
      if(!perLane.length){ alert('No results yet. Click Calculate & Map first.'); return; }
      const headers = ['Lane','Origin','Destination','Loaded_mi','Deadhead_mi','Rate_per_ton','Tons','Gross','Lane_RPM'];
      const rows = perLane.map(L=>[
        L.index,
        '"'+L.origin.replaceAll('"','""')+'"',
        '"'+L.destination.replaceAll('"','""')+'"',
        fmtMi(L.loaded),
        fmtMi(L.deadhead),
        L.rate?.toFixed(2)||'',
        L.tons?.toFixed(1)||'',
        (L.gross||0).toFixed(2),
        (L.gross / (L.loaded+L.deadhead||1)).toFixed(2)
      ]);
      const csv = [headers.join(','), ...rows.map(r=>r.join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'lanes_export.csv'});
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    /* ---------- Proposal (unchanged visual) ---------- */
    function openProposal(){
      if(!lastCompute){ alert('Calculate first, then open the proposal.'); return; }
      const { perLane, finalDhMiles, base, includeStartDH, returnToBase, url } = lastCompute;

      let loaded=0, deadhead=0, gross=0;
      perLane.forEach(L=>{ loaded+=L.loaded; deadhead+=L.deadhead; gross+=L.gross; });
      deadhead += finalDhMiles;
      const total = loaded + deadhead;
      const rpmAll = gross / (total || 1);
      const rpmLoaded = gross / (loaded || 1);

      const flags = [];
      if(includeStartDH && base) flags.push('Base→first origin DH included');
      if(returnToBase && base)   flags.push('Final DH back to Base included');

      const esc = s => (s??'').toString().replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
      const rowsHtml = perLane.map(L=>{
        const laneRPM = L.gross / (L.loaded+L.deadhead||1);
        return `<tr>
          <td style="text-align:center">${L.index}</td>
          <td>${esc(L.origin)} → ${esc(L.destination)}</td>
          <td style="text-align:right">${fmtMi(L.loaded)}</td>
          <td style="text-align:right">${fmtMi(L.deadhead)}</td>
          <td style="text-align:right">${L.rate?Number(L.rate).toFixed(2):''}</td>
          <td style="text-align:right">${L.tons?Number(L.tons).toFixed(1):''}</td>
          <td style="text-align:right">${fmtMoney(L.gross||0)}</td>
          <td style="text-align:right">${laneRPM?laneRPM.toFixed(2):''}</td>
        </tr>`;
      }).join('');

      const plain = [
        'Proposed Lanes Summary',
        base?('Base/Yard: '+base):'',
        flags.length?('Notes: '+flags.join('; ')):'',
        '',
        ...perLane.flatMap(L=>{
          const laneRPM=L.gross/(L.loaded+L.deadhead||1);
          return [
            `Lane ${L.index}: ${L.origin} → ${L.destination}`,
            `  Loaded: ${fmtMi(L.loaded)} mi | Deadhead: ${fmtMi(L.deadhead)} mi`,
            `  Rate: $${(L.rate||0).toFixed(2)}/ton × ${(L.tons||0).toFixed(1)} tons = ${fmtMoney(L.gross||0)}`,
            `  Lane RPM: $${laneRPM.toFixed(2)}`,
            ''
          ];
        }),
        `TOTAL Loaded: ${fmtMi(loaded)} mi`,
        `TOTAL Deadhead: ${fmtMi(deadhead)} mi`,
        `TOTAL Miles: ${fmtMi(total)} mi`,
        `TOTAL Gross: ${fmtMoney(gross)}`,
        `Overall RPM (all miles): $${rpmAll.toFixed(2)}`,
        `Loaded-only RPM: $${rpmLoaded.toFixed(2)}`,
        '',
        'Open in calculator: '+url
      ].filter(Boolean).join('\n');

      const html = `<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Lane Proposal – FarmPro</title>
      <style>body{font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0b1320;margin:24px}
      h1{margin:0 0 6px;font-size:20px}.muted{color:#586278}.actions{margin:12px 0;display:flex;gap:8px;flex-wrap:wrap}
      button{padding:8px 10px;border-radius:8px;border:1px solid #c8d1e0;background:#0d63ff;color:#fff;cursor:pointer}
      button.secondary{background:#fff;color:#0b1320;border-color:#c8d1e0}
      table{width:100%;border-collapse:collapse;margin-top:12px}th,td{padding:8px;border-bottom:1px solid #e5e9f2}
      th{text-align:right;background:#f6f8fc}th:first-child,td:first-child{text-align:center}th:nth-child(2),td:nth-child(2){text-align:left}
      tfoot td{font-weight:700}pre{white-space:pre-wrap;background:#f6f8fc;border:1px solid #e5e9f2;border-radius:8px;padding:10px;margin-top:12px}</style>
      </head><body>
        <h1>Proposed Lanes Summary</h1>
        ${base?`<div class="muted">Base/Yard: ${esc(base)}</div>`:''}
        ${flags.length?`<div class="muted">Notes: ${esc(flags.join('; '))}</div>`:''}
        <div class="actions">
          <button id="copy">Copy Plain Text</button>
          <button id="print" class="secondary">Print / Save PDF</button>
        </div>
        <table><thead><tr><th>#</th><th>Origin → Destination</th><th>Loaded mi</th><th>Deadhead mi</th><th>$ / ton</th><th>Tons</th><th>Gross</th><th>Lane RPM</th></tr></thead>
          <tbody>${rowsHtml}</tbody>
          <tfoot><tr><td colspan="2">Totals</td><td style="text-align:right">${fmtMi(loaded)}</td><td style="text-align:right">${fmtMi(deadhead)}</td><td></td><td></td><td style="text-align:right">${fmtMoney(gross)}</td><td style="text-align:right">${(gross/(loaded+deadhead||1)).toFixed(2)}</td></tr></tfoot>
        </table>
        <pre id="plain">${plain.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}</pre>
        <script>(function(){const t=document.getElementById('plain').textContent;
          document.getElementById('copy').onclick=()=>{if(navigator.clipboard?.writeText){navigator.clipboard.writeText(t).then(()=>alert('Copied'))}else{const a=document.createElement('textarea');a.value=t;document.body.appendChild(a);a.select();document.execCommand('copy');a.remove();alert('Copied')}};document.getElementById('print').onclick=()=>window.print();})();<\/script>
      </body></html>`;

      const blob = new Blob([html], { type: 'text/html' });
      const urlBlob = URL.createObjectURL(blob);
      const w = window.open(urlBlob, '_blank', 'noopener');
      if(!w){ const a=document.createElement('a'); a.href=urlBlob; a.target='_blank'; a.rel='noopener'; a.download='proposal.html'; document.body.appendChild(a); a.click(); a.remove(); }
      setTimeout(()=>URL.revokeObjectURL(urlBlob), 60000);
    }

    function collectPerLaneFromTable(){
      const rows = Array.from($('#resultsTable tbody').rows);
      if(!rows.length) return [];
      return rows.map(tr=>{
        const tds = tr.cells;
        const [index, pair, loaded, deadhead, rate, tons, gross] = [
          Number(tds[0].textContent),
          tds[1].textContent,
          Number(tds[2].textContent.replace(/,/g,'')),
          Number(tds[3].textContent.replace(/,/g,'')),
          Number(tds[4].textContent),
          Number(tds[5].textContent),
          Number(tds[6].textContent.replace(/[$,]/g,''))
        ];
        const [origin, destination] = pair.split(' → ').map(s=>s.trim());
        return {index, origin, destination, loaded, deadhead, rate, tons, gross};
      });
    }

    function escapeHtml(str){
      return str.replace(/[&<>"]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));
    }

    /* ---------- Saved lanes library ---------- */
    function loadLibrary(){ try{ library = JSON.parse(localStorage.getItem('farmpro_saved')||'[]'); }catch(_){ library=[]; } }
    function persistLibrary(){ localStorage.setItem('farmpro_saved', JSON.stringify(library)); }
    function renderLibrary(){
      const list = $('#savedList'); list.innerHTML='';
      library.forEach((L, i)=>{
        const item = document.createElement('div');
        item.className='saved-item';
        item.innerHTML = `
          <div class="meta">
            <div class="t">${escapeHtml(L.origin)} → ${escapeHtml(L.destination)}</div>
            <div class="muted">$${(L.rate||0).toFixed(2)}/ton • ${(L.tons||0).toFixed(1)} tons</div>
          </div>
          <div class="row">
            <button type="button" class="btn ghostbtn add">➕</button>
            <button type="button" class="btn ghostbtn del">✕</button>
          </div>`;
        item.querySelector('.add').onclick = ()=> addLane(L);
        item.querySelector('.del').onclick = ()=>{ library.splice(i,1); persistLibrary(); renderLibrary(); };
        list.appendChild(item);
      });
    }
    function saveSelectedLane(){
      const node = $('#lanes .lane.selected') || $('#lanes .lane');
      if(!node){ alert('Add a lane first'); return; }
      const o = node.querySelector('.origin').value.trim();
      const d = node.querySelector('.destination').value.trim();
      const rate = parseFloat(node.querySelector('.rate').value)||0;
      const tons = parseFloat(node.querySelector('.tons').value)||0;
      if(!o || !d){ alert('Enter origin and destination first'); return; }
      library.push({origin:o, destination:d, rate, tons}); persistLibrary(); renderLibrary();
    }
    function exportLibrary(){
      const blob = new Blob([JSON.stringify(library,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'saved_lanes.json'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function importLibrary(){
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = ()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader();
        r.onload = ()=>{ try{ const data=JSON.parse(r.result); if(Array.isArray(data)){ library=data; persistLibrary(); renderLibrary(); } }catch(_){ alert('Bad JSON'); } };
        r.readAsText(f);
      };
      inp.click();
    }

    /* ---------- Optimizer (min deadhead) ---------- */
    function readLanesForOpt(){ return readLanes(); }
    function dmMiles(a,b){
      return new Promise((resolve, reject)=>{
        if(!dmService) return reject(new Error('DistanceMatrix not ready'));
        dmService.getDistanceMatrix({origins:[a],destinations:[b],travelMode:'DRIVING',region:'US',unitSystem:google.maps.UnitSystem.IMPERIAL},
          (res, status)=>{
            if(status==='OK' && res.rows[0]?.elements[0]?.status==='OK'){
              resolve(metersToMiles(res.rows[0].elements[0].distance.value));
            } else resolve(Infinity);
          });
      });
    }
    async function buildMatrix(lanes, base, includeStart, returnTo){
      const n=lanes.length;
      const M=Array.from({length:n},()=>Array(n).fill(0));
      const tasks=[];
      for(let i=0;i<n;i++) for(let j=0;j<n;j++){
        if(i===j){ M[i][j]=Infinity; continue; }
        tasks.push(dmMiles(lanes[i].destination, lanes[j].origin).then(mi=>{ M[i][j]=mi; }));
      }
      let baseTo=Array(n).fill(Infinity), toBase=Array(n).fill(Infinity);
      if(base && includeStart) for(let j=0;j<n;j++) tasks.push(dmMiles(base, lanes[j].origin).then(mi=>{ baseTo[j]=mi; }));
      if(base && returnTo)     for(let i=0;i<n;i++) tasks.push(dmMiles(lanes[i].destination, base).then(mi=>{ toBase[i]=mi; }));
      await Promise.all(tasks);
      return {M, baseTo, toBase};
    }
    function permutations(arr){
      const res=[]; const used=Array(arr.length).fill(false); const cur=[];
      (function dfs(){ if(cur.length===arr.length){ res.push(cur.slice()); return; }
        for(let i=0;i<arr.length;i++){ if(used[i]) continue; used[i]=true; cur.push(arr[i]); dfs(); cur.pop(); used[i]=false; }
      })(); return res;
    }
    function cost(order,M,baseTo,toBase){
      let d=0; if(baseTo.length && isFinite(baseTo[order[0]])) d+=baseTo[order[0]];
      for(let i=0;i<order.length-1;i++){ const c=M[order[i]][order[i+1]]; if(!isFinite(c)) return Infinity; d+=c; }
      if(toBase.length && isFinite(toBase[order[order.length-1]])) d+=toBase[order[order.length-1]];
      return d;
    }
    async function optimizeOrder(){
      const lanes = readLanesForOpt();
      if(lanes.length<2){ alert('Add at least two lanes to optimize.'); return; }
      const base = $('#base').value.trim();
      const includeStart = $('#includeStartDH').checked && !!base;
      const returnBase   = $('#returnToBase').checked && !!base;

      try{
        const {M, baseTo, toBase} = await buildMatrix(lanes, base, includeStart, returnBase);
        const n=lanes.length;
        let order=[...Array(n).keys()], bestCost=Infinity;

        if(n<=7){
          for(const ord of permutations(order)){
            const c = cost(ord, M, includeStart?baseTo:[], returnBase?toBase:[]);
            if(c<bestCost){ bestCost=c; order=ord; }
          }
        } else {
          // Greedy nearest-neighbor
          let start=0;
          if(includeStart){ let min=Infinity; for(let j=0;j<n;j++){ if(baseTo[j]<min){min=baseTo[j]; start=j;} } }
          const used=Array(n).fill(false); used[start]=true; order=[start];
          for(let step=1; step<n; step++){
            const i=order[order.length-1];
            let bestJ=-1, best=Infinity;
            for(let j=0;j<n;j++){ if(used[j]) continue; if(M[i][j]<best){best=M[i][j]; bestJ=j;} }
            used[bestJ]=true; order.push(bestJ);
          }
          bestCost = cost(order, M, includeStart?baseTo:[], returnBase?toBase:[]);
        }

        // Apply order to DOM
        const wrap=$('#lanes'); const nodes=$$('#lanes .lane'); order.map(i=>nodes[i]).forEach(n=>wrap.appendChild(n));
        refreshLaneIndices(); persist();
        alert(isFinite(bestCost) ? `Order optimized. Estimated deadhead: ${fmtMi(bestCost)} mi.` : 'Order optimized.');
      }catch(e){ console.warn('optimize failed', e); alert('Could not optimize (Distance Matrix might be blocked).'); }
    }

    /* ---------- Persistence ---------- */
    function persist(){
      const data = { base: $('#base').value.trim(), includeStartDH: $('#includeStartDH').checked, returnToBase: $('#returnToBase').checked, lanes: readLanes() };
      localStorage.setItem('farmpro_lanes', JSON.stringify(data));
    }
    function loadFromStorage(){
      try{
        const raw = localStorage.getItem('farmpro_lanes');
        if(!raw) { addLane(); return true; }
        const data = JSON.parse(raw);
        $('#base').value = data.base||'';
        $('#includeStartDH').checked = !!data.includeStartDH;
        $('#returnToBase').checked = !!data.returnToBase;
        $('#lanes').innerHTML='';
        (data.lanes||[]).forEach(addLane);
        if(!(data.lanes||[]).length) addLane();
        return true;
      }catch(e){ addLane(); return true; }
    }
    function updateShareURL(){
      const payload = { base: $('#base').value.trim(), i: $('#includeStartDH').checked?1:0, r: $('#returnToBase').checked?1:0, lanes: readLanes() };
      const qp = new URLSearchParams({state: btoa(unescape(encodeURIComponent(JSON.stringify(payload))))});
      const url = location.origin + location.pathname + '?' + qp.toString();
      history.replaceState(null,'',url);
    }
    function loadFromURL(){
      const s = new URLSearchParams(location.search).get('state');
      if(!s) return false;
      try{
        const data = JSON.parse(decodeURIComponent(escape(atob(s))));
        $('#base').value = data.base||'';
        $('#includeStartDH').checked = !!data.i;
        $('#returnToBase').checked = !!data.r;
        $('#lanes').innerHTML='';
        (data.lanes||[]).forEach(addLane);
        if(!(data.lanes||[]).length) addLane();
        return true;
      }catch(e){ return false; }
    }

    /* ---------- Sample & Clear ---------- */
    function loadSample(){
      $('#lanes').innerHTML='';
      addLane({origin:'Mankato, MN', destination:'Lake Mills, WI', rate:38, tons:26});
      addLane({origin:'Cambria, WI', destination:'Milwaukee, WI', rate:14, tons:26});
      addLane({origin:'Racine, WI', destination:'East Dubuque, IL', rate:19, tons:26});
      addLane({origin:'East Dubuque, IL', destination:'Stanhope, IA', rate:24, tons:26});
      $('#base').value = 'Fairbank, IA';
      $('#includeStartDH').checked = true;
      $('#returnToBase').checked = true;
      persist();
    }
    function clearAll(){
      if(!confirm('Clear all lanes and settings?')) return;
      localStorage.removeItem('farmpro_lanes');
      $('#lanes').innerHTML='';
      $('#base').value='';
      $('#includeStartDH').checked = true;
      $('#returnToBase').checked = false;
      addLane();
      history.replaceState(null,'',location.pathname);
      clearMap();
      $('#resultsTable').hidden = true;
      lastCompute = null;
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&libraries=places&callback=initMap"></script>
</body>
</html>
